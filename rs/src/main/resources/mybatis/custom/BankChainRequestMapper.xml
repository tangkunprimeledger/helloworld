<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.higgs.trust.rs.custom.dao.BankChainRequestDAO">

	<insert id="insertRequest" parameterType="com.higgs.trust.rs.custom.dao.po.BankChainRequestPO">
		INSERT INTO bankchain_request(request_id,
								biz_type,
								status,
								resp_code,
								resp_msg,
								create_time,
								update_time)
					  VALUES (#{reqNo},
					  			#{bizType},
					  			#{status},
					  			#{respCode},
					  			#{respMsg},
					  			now(),
					  			now())
	</insert>


	<select id="queryRequest" resultType="com.higgs.trust.rs.custom.dao.po.BankChainRequestPO">
		SELECT request_id as reqNo,
				biz_type as bizType,
				status as status,
				resp_code as respCode,
				resp_msg as respMsg,
				create_time as createTime,
				update_time as updateTime
		FROM bankchain_request WHERE status = 'INIT' limit 50
	</select>

	<select id="queryRequestByReqNo" parameterType="java.lang.String" resultType="com.higgs.trust.rs.custom.dao.po.BankChainRequestPO">
		SELECT request_id as reqNo,
				biz_type as bizType,
				status as status,
				resp_code as respCode,
				resp_msg as respMsg,
				create_time as createTime,
				update_time as updateTime
		FROM bankchain_request WHERE request_id = #{reqNo}
	</select>



	<!-- 将request状态从INIT更新为PROCESSING -->
	<update id="updateRequestToProc" parameterType="java.lang.String">
		UPDATE bankchain_request SET status = 'PROCESSING',
										update_time =now()
								  WHERE request_id = #{reqNo} and  status = 'INIT'
	</update>

	<!-- 对于重复的key且flag=999，即不需要覆盖的情形，直接将状态修改为DUPLICATE -->
	<update id="updateRequestToDuplicate" parameterType="java.lang.String">
		UPDATE bankchain_request SET status = 'DUPLICATE',
										update_time =now()
									WHERE request_id = #{reqNo} and  status = 'INIT'
	</update>

	<!-- callback回来的数据的终态处理 -->
	<update id="updateRequest" parameterType="com.higgs.trust.rs.custom.dao.po.BankChainRequestPO">
		UPDATE bankchain_request SET status = #{status},
									update_time =now()
								  WHERE request_id = #{reqNo} and  status = 'PROCESSING'
	</update>

</mapper>
